{% extends "layout.html" %}
{% load static %}
{% load i18n %}

{% block token_head %}
	<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block title %}
{% trans "Tournament's Pong Game" %}
{% endblock %}

{% block undertitle %}
<h2><strong class="gradient-text">{% trans "Tournament's Pong Game" %}</strong></h2>

<form id="tournament4-form" method="POST" action="{% url 'match:tournament_final' %}">
	{% csrf_token %}
	<div id="resultContainer">
		<div class="result-content" id="resultContent">
			<span class="close-button" onclick="closeFriendModal()">Ã—</span>
			<h2><strong class="gradient-text">{% trans "Final Match" %}</strong></h2>
			<p>{% trans "Prepare yourselves for the final match:" %}</p>
			<input type="text" id="winner1" class="winner-light" name="winner1" value="">
			<img src="{% static 'imgs/cross.png' %}" class="versus-small">
			<input type="text" id="winner2" class="winner-light" name="winner2" value="">
			<input type="hidden" id="turns" class="turns" name="turns" value="{{ turns }}">
			<button type="button" class="small-button" id="finalButton" onclick="prepareForm(event)">Go to Final!</button>
		</div>
	</div>
	<div class="tournament-first-round">
		<div>
			<h3 class="gradient-text">First Match</h3>
			<p>{{ nicknames.0 }} <img src="{% static 'imgs/cross.png' %}" class="versus-small"> {{ nicknames.1 }}</p>
			<button type="button" id="first-match-button" class="small-button" onclick="startMatch('{{ usernames.0 }}', '{{ usernames.1 }}', '{{ nicknames.0 }}', '{{ nicknames.1 }}', '{{ turns }}', '1')">
				Start Match
			</button>
			<div class="match-result">
				<input type="hidden" id="match-resultA-player" name="match-resultA-player" value="{{ usernames.0 }}">
				<input type="hidden" id="match-resultA-score" name="match-resultA-score" placeholder="Score A" value="">
				<input type="hidden" id="match-resultB-player" name="match-resultB-player" value="{{ usernames.1 }}">
				<input type="hidden" id="match-resultB-score" name="match-resultB-score" placeholder="Score B" value="">
				<input type="hidden" id="winner1" class="winner-dark" name="winner1" value="">
			</div>
		</div>
		<div>
		</div>
		<div class="see-results">
			{% comment %} <button type="button" id="see-results" class="small-button">{% trans See Results%}</button> {% endcomment %}
			<button type="button" id="see-results" class="small-button">See Results</button>
		</div>
		<div>
			<h3 class="gradient-text">Second Match</h3>
			<p>{{ nicknames.2 }} <img src="{% static 'imgs/cross.png' %}" class="versus-small"> {{ nicknames.3 }}</p>
			<button type="button" id="second-match-button" class="small-button" onclick="startMatch('{{ usernames.2 }}', '{{ usernames.3 }}', '{{ nicknames.2 }}', '{{ nicknames.3 }}', '{{ turns }}', '2')">
				Start Match
			</button>
			<div class="match-result">
				<input type="hidden" id="match-resultC-player" name="match-resultC-player"value="{{ usernames.2 }}">
				<input type="hidden" id="match-resultC-score" name="match-resultC-score" placeholder="Score C" value="">
				<input type="hidden" id="match-resultD-player" name="match-resultD-player" value="{{ usernames.3 }}">
				<input type="hidden" id="match-resultD-score" name="match-resultD-score" placeholder="Score D" value="">
				<input type="hidden" id="winner2" class="winner-dark" name="winner2" value="">
			</div>			
		</div>
	</div>
</form>
{% endblock %}

{% block content %}
	<canvas></canvas>
{% endblock %}

{% block content2 %}
	<style>
		#see-results {
			display: none;
			justify-content: center;
			align-items: center;
			margin: 0 auto;
			}
			
		.see-results {
			display: flex;
			justify-content: center;
		}

		h2 {
			margin-bottom: 10px;
		}
		
		.tournament-first-round {
			display: flex;
			flex-direction: row;
			gap: 50px;
			margin-bottom: 10px;
		}
		.match-result {
			display: flex;
		}
		#resultContainer {
			display: none; /* Inicialmente escondido */
			position: fixed;
			z-index: 9999;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0, 0, 0, 0.5);
		}

		.versus-small {
		width: 20px;
		height: 20px;
		align-items: center;
		padding: 5px;
		vertical-align: middle;
		}

		.result-content {
			margin-bottom: 10px;
			background-color: #c3c6f1;
			margin: 15% auto; /* Margem para centralizar verticalmente */
			padding: 20px;
			border: 1px solid #858cee;
			border-radius: 10px;
			width: 30%;
			color: #040c30;
			position: relative;
		}

		.close-button {
			position: absolute;
			top: 10px;
			right: 15px;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}
	</style>
{% endblock %}

{% block scripts %}
<script>
	document.addEventListener('DOMContentLoaded', function() {
		document.getElementById('resultContainer').style.display = 'none';
	
		const first_match = document.getElementById('first-match-button');
		const second_match = document.getElementById('second-match-button');

		const see_results = document.getElementById('see-results');
	
		first_match.addEventListener('click', function() {
			first_match.style.display = 'none';
			checkButtons();
		});
	
		second_match.addEventListener('click', function() {
			second_match.style.display = 'none';
			checkButtons();
		});
	
		function checkButtons() {
			if (first_match.style.display === 'none' && second_match.style.display === 'none') {
				see_results.style.display = 'block';
			}
		}
		see_results.addEventListener('click', function() {
			document.getElementById('resultContent').style.display = 'block';
			document.getElementById('resultContainer').style.display = 'block';
		});
	});

	let scriptLoaded = false;

	function prepareForm(event) {
		event.preventDefault();
		document.getElementById('tournament4-form').submit();
	}
	
	function startMatch(username1, username2, nickname1, nickname2, turns, matchNumber) {
		if (scriptLoaded) {
			Game.initialize(username1, username2, nickname1, nickname2, turns, matchNumber);
			return;
		}
		scriptLoaded = true;
		const script = document.createElement('script');
		script.src = "{% static 'js/tournament_games.js' %}";
		script.onload = () => {
			Game.initialize(username1, username2, nickname1, nickname2, turns, matchNumber);
		};
		script.onerror = () => {
			scriptLoaded = false;
		};
		document.body.appendChild(script);
	}
</script>
{% endblock %}
