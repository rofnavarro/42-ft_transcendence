{% extends 'layout.html' %}

{% block title %}
	Play
{% endblock %}

{% block undertitle %}
	<h1>Local Match Settings</h1>
{% endblock %}

{% block content %}
	<form id="game-form" method="POST" action="{% url 'match:match' %}">
		{% csrf_token %}
		<div class="local-play">
			<div id="qtd-jogadores">
				<h2>Players</h2>
				<input type="radio" name="qtd_jogadores" value="2_jogadores" checked onclick="togglePlayers(2)">
				<label>2</label>
				<input type="radio" name="qtd_jogadores" value="4_jogadores" onclick="togglePlayers(4)">
				<label>4</label>
			</div>
			<div id="qtd-turnos">
				<h2>Rounds</h2>
				<input type="radio" name="qtd-turnos" value="1" checked>
				<label>1</label>
				<input type="radio" name="qtd-turnos" value="3">
				<label>3</label>
				<input type="radio" name="qtd-turnos" value="5">
				<label>5</label>
			</div>
			<div id="game-background">
				<h2>Background</h2>
				<input type="radio" name="background" value="#0a0a0a" checked>
				<label>Dark</label>
				<input type="radio" name="background" value="#E6E6FA">
				<label>Light</label>
				<input type="radio" name="background" value="#7B68EE">
				<label>Modern</label>
			</div>
		</div>
		<div id="local-players">
			<h2>Players</h2>
			<div class="players">
				<div id="player1" class="player">
					<h3>Player 1 (You)</h3>
					<input type="hidden" id="player1-name" name="player1" value="{{ request.user.username }}">
					<input type="hidden" id="player1-nickname" name="player1-nickname" value="{{ request.user.nickname }}">
					<span id="player1-label">{{ request.user.nickname }}</span>
				</div>
				<div id="player2" class="player">
					<h3>Player 2</h3>
					<button type="button" id="invite-btn-2" onclick="openFriendModal(2)">Invite Friend</button>
					<input type="hidden" id="player2-name" name="player2">
					<input type="hidden" id="player2-nickname" name="player2-nickname">
					<span id="player2-label"></span>
				</div>
			</div>
			<div class="players">
				<div id="player3" class="player" style="display: none;">
					<h3>Player 3</h3>
					<button type="button" id="invite-btn-3" onclick="openFriendModal(3)">Invite Friend</button>
					<input type="hidden" id="player3-name" name="player3">
					<input type="hidden" id="player3-nickname" name="player3-nickname">
					<span id="player3-label"></span>
				</div>
				<div id="player4" class="player" style="display: none;">
					<h3>Player 4</h3>
					<button type="button" id="invite-btn-4" onclick="openFriendModal(4)">Invite Friend</button>
					<input type="hidden" id="player4-name" name="player4">
					<input type="hidden" id="player4-nickname" name="player4-nickname">
					<span id="player4-label"></span>
				</div>
			</div>
		</div>

		<div>
			<button type="submit" class="submit-button" onclick="prepareForm()">Start Game!</button>
		</div>
	</form>

	<div id="friend-modal" style="display:none;">
		<div class="modal-content">
			<h2>Invite a Friend</h2>
			<ul id="friends-list">
				{% for friend in friends %}
					<li><a href="#" onclick="selectFriend('{{ friend.username }}', '{{ friend.nickname }}', currentPlayer)"> {{ friend.nickname }} </a></li>
				{% empty %}
					<li>You still don't have any friends.</li>
					<li>You Loser!</li>
				{% endfor %}
			</ul>
			<button onclick="closeFriendModal()">Close</button>
		</div>
	</div>

{% endblock %}

{% block scripts %}
	<script>
		function togglePlayers(qtd) {
			if (qtd === 2) {
				document.getElementById('player3').style.display = 'none';
				document.getElementById('player4').style.display = 'none';
			} else {
				document.getElementById('player3').style.display = 'block';
				document.getElementById('player4').style.display = 'block';
			}
		}

		window.onload = function() {
			togglePlayers(2);
		}

		function openFriendModal(playerId) {
			currentPlayer = playerId;
			document.getElementById('friend-modal').style.display = 'block';
		}

		function closeFriendModal() {
			document.getElementById('friend-modal').style.display = 'none';
		}

		function selectFriend(username, nickname, playerId) {
			document.getElementById(`player${playerId}-name`).value = username;
			document.getElementById(`player${playerId}-nickname`).value = nickname;
			document.getElementById(`player${playerId}-label`).innerText = nickname;
			document.getElementById(`invite-btn-${playerId}`).style.display = 'none';
			closeFriendModal();
		}

		function prepareForm() {
			const player1 = document.getElementById('player1-name').value;
			const player2 = document.getElementById('player2-name').value;
			const player3 = document.getElementById('player3-name').value;
			const player4 = document.getElementById('player4-name').value;

			const turns = document.querySelector('input[name="qtd-turnos"]:checked').value;

			const color = document.querySelector('input[name="background"]:checked').value;

			const players = [player1, player2];
			if (document.getElementById('player3').style.display !== 'none') players.push(player3);
			if (document.getElementById('player4').style.display !== 'none') players.push(player4);

			const validPlayers = players.filter(player => player !== '');

			if (validPlayers.length < 2) {
				alert('Need at last 2 players.');
				event.preventDefault();
			}
		}
	</script>
{% endblock %}
